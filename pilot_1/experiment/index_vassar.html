<!DOCTYPE html>
<html>

<head>
  <title>URSI LLM Convo Bot Experiment</title>
  <!-- loading jsPsych -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />

  <!-- loading jsPsych plug-ins -->
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe@0.1"></script> <!-- for data pipe -->
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@latest"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script> <!-- condition assignment using data pipe -->
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="chat-plugin/index.browser.js"></script> <!--- local chat plug-in access-->
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.3"></script>
  <link rel="stylesheet" href="https://unpkg.com/@jspsych/plugin-survey@1.0.1/css/survey.css" />
  <script src="https://unpkg.com/@jspsych/plugin-survey@1.0.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script> <!--- for control intervention--- 

    <!-- loading react-->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script> <!-- -->
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script> <!--  -->

  <!-- surveyJS slider plug-in upload -->
  <link href="https://unpkg.com/browse/nouislider@15.8.0/package.json" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.js"></script>

  <!-- uploading pre-convo survey question jsons -->
  <script src="open_survey_pilot_questions.js"></script> <!-- survey -->

  <!-- loading css -->
  <link href="styles.css" rel="stylesheet" type="text/css"> <!-- local-ui access -->


  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cantarell:ital,wght@0,400;0,700;1,400;1,700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Exo:ital,wght@0,100..900;1,100..900&display=swap');

    /* slider format */
    .slider {
      font-size: 25px;
      font-weight: bold;
      color: black;
    }

    /* increase font size everywhere for mobile use */
    /* Target all survey elements more specifically */
.sd-table__cell,
.sd-table__header,
.sd-matrix__cell,
.sd-item__control-label,
.sd-checkbox__label,
.sd-radio__label,
.sd-selectbase__label,
.sv-string-viewer,
label {
  font-size: 21px !important;
}

    
    .jspsych-display-element {
      font-size: 25px;
    }

    .jspsych-content {
      font-size: 30px;
    }

    .jspsych-survey-question {
      font-size: 30px;
    }

    .jspsych-btn {
      font-size: 30px;
    }
  </style>
</head>

<body>
  <script>

    //Initialize jsPsych
    var jsPsych = initJsPsych({
      on_finish: function () {
        // jsPsych.data.displayData();
        const displayElement = document.getElementById('jspsych-content') || document.body;
        displayElement.innerHTML = `
        <p style="font-size: 1.25rem; color: #555;">
        </p>
Thank you for your contribution to our research! Feel free to exit the page.  
    </p>
      </div>
    `;
      },
    }
    );

    // disable right-click to prevent accesing browser console (to prevent user from seeing chat-bot prompt)
    document.addEventListener('contextmenu', function (e) {
      e.preventDefault();
    });


    // disable keyboard shortcuts
    document.addEventListener('keydown', function (e) {
      if (e.key === 'F12' ||
        (e.ctrlKey && e.shiftKey && e.key === 'I') ||
        (e.ctrlKey && e.shiftKey && e.key === 'J') ||
        (e.ctrlKey && e.key === 'U') ||
        (e.ctrlKey && e.shiftKey && e.key === 'C')) {
        e.preventDefault();
      }
    });

    // disable text selection
    document.addEventListener('selectstart', function (e) {
      e.preventDefault();
    });


    // create timelines for conditions. the contents of each timeline are at the bottom of this doc
    var control_timeline = [];

    // sequential condition assignment using data pipe. pushing a condition timeline into the timeline variable
    var timeline = [];
    async function createExperiment() {
      const condition = 0 //await jsPsychPipe.getCondition("P09AXWX5b5t6");
      if (condition == 0) { timeline = control_timeline; }
      jsPsych.run([...timeline, save_data]);
    }

    // setting subject_id and filename for confidential data analysis 
    const subject_id = jsPsych.randomization.randomID(10);
    const filename = `${subject_id}.csv`;

    /*  welcome message  */
    var welcome = {
      data: {
        phase: "welcome-message",
      },
      type: jsPsychHtmlButtonResponse,
      stimulus: "Welcome! In this study, you will fill out a questionnaire.",
      choices: ['Tap to Start'],
    };

    /* pre-chat survey with different topic options implemented via SurveyJS */

    /* create slider constant for pre-convo survey */
    const initializePreSlider = (survey) => {
      //search for every question in the surveyJs with -placeholder in the name, and add a variable for each slider. 
      //because we put the slider and the question for the text as two seperate question, and named the question text with 'placeholder'
      survey.onAfterRenderQuestion.add(function (survey, options) {
        const name = options.question.name;

        // if (sliderQuestions.has(name)) {
        if (name.includes("-placeholder")) {

          var slider = document.getElementById(name);
          noUiSlider.create(slider, {
            start: [50],
            range: {
              min: 0,
              max: 100,
            },
            step: 1,
            tooltips: true,
          });
          slider.noUiSlider.on("set", function () {
            options.question.value = slider.noUiSlider.get();
          });
        }
      });
    };


    /// EXTRACTING STRONGEST TOPIC CHOICE 
    // defining the function to extract the topic that people rate most strongly from the first survey so that we can give them a second survey based on their answer 

    let topicChoiceResponse = [];
    let topicChoiceAsString;

    function extractRelevantTopicChoiceRow(responses) {
      let relevantTopicChoiceRow = [];

      // Function to find a row with specific column values
      function findTopicChoiceRowWithValue(values) {
        for (let row in responses) {
          let columnValue = responses[row];
          if (columnValue === values) {
            return [{ row }];
          }
        }
        return null;
      }


      // Loop to check i or 8-i)
      for (let i = 1; i <= 6; i++) {
        // Check for i
        relevantTopicChoiceRow = findTopicChoiceRowWithValue(i);
        if (relevantTopicChoiceRow !== null) {
          return relevantTopicChoiceRow;
        }
      }
      return relevantTopicChoiceRow;

    }


    let topicChoice;

    /* pushing survey in timeline with both slider and non-slider questions */
    const survey_trial = {
      type: jsPsychSurvey,
      survey_json: open_survey_vassar_json,
      survey_function: initializePreSlider,
      data: {
        phase: "pre-convo-survey-initial",
      },
      on_finish: (data) => {

        // for post-survey party-specific questions (so republicans only answer question republicans, vice versa for democrat)
        data.response["political-affiliation"];

        // extract and process the responses for the specific question
        let topicChoiceResponse = data.response["topic"];
        if (topicChoiceResponse) {
          // extract most uncomfortable topic
          let relevanttopicChoiceRow = extractRelevantTopicChoiceRow(topicChoiceResponse);

          // convert topic into a string so it can be fed into chat later
          relevanttopicChoiceRow.forEach(rowObj => {
            data.topicChoiceAsString = rowObj;
            console.log(data.topicChoiceAsString);
            console.log(data.topicChoiceAsString["row"]);
            topicChoice = data.topicChoiceAsString["row"]
            console.log(topicChoice);
          });
        }
      }
    }

    const topic = topicChoice;

    /// EXTRACTING DEPOLARIZATION STRING FROM TOPIC-SPECIFIC PRE-CONVO SURVEYS
    let polarizationResponses = [];

    function extractRelevantPolarizationRow(responses) {
      let relevantPolarizationRow = [];

      // Function to find a row with specific column values
      function findPolarizationRowWithValue(values) {
        for (let row in responses) {
          let columnValue = responses[row];
          if (columnValue === values) {
            return [{ row }];
          }
        }
        return null;
      }

      // Loop to check i or 7-i)
      for (let i = 1; i <= 3; i++) {
        // Check for i
        relevantPolarizationRow = findPolarizationRowWithValue(i);
        if (relevantPolarizationRow !== null) {
          return relevantPolarizationRow;
        }
        // Check for 7 - i
        relevantPolarizationRow = findPolarizationRowWithValue(7 - i);
        if (relevantPolarizationRow !== null) {
          return relevantPolarizationRow;
        }
      }
      return relevantPolarizationRow;

    }

    // TOPIC SPECIFIC PRE-CONVERSATION SURVEYS 


    // store the unwillingness-reason rows in a var to help us use them in the next survey part 
    var unwillingness_concern_rows = [
      {
        value: "unwillingness-reason-I could incur social repercussions (e.g., being excluded by others in the future, negative changes to my reputation, feeling ostracized)",
        text: "I could incur social repercussions (e.g., being excluded by others in the future, negative changes to my reputation, feeling ostracized)",
      },
      {
        value: "unwillingness-reason-Someone could criticize or show disapproval of my views",
        text: "Someone could criticize or show disapproval of my views",
      },
      {
        value:
          "unwillingness-reason-I would feel like my opinion is unpopular amongst the group",
        text: "I would feel like my opinion is unpopular amongst the group",
      },
      {
        value:
          "unwillingness-reason-My opinion is unpopular in general",
        text: "My opinion is unpopular in general",
      },
      {
        value:
          "unwillingness-reason-Someone could challenge ideas or beliefs that play an important role in making me who I am",
        text: "Someone could challenge ideas or beliefs that play an important role in making me who I am",
      },
      {
        value:
          "unwillingness-reason-I could feel humiliated or embarrassed in the conversation",
        text: "I could feel humiliated or embarrassed in the conversation",
      },
      {
        value:
          "unwillingness-reason-I might struggle to explain my views to the others and/or come across as uninformed",
        text: "I might struggle to explain my views to the others and/or come across as uninformed",
      },
      {
        value:
          "unwillingness-reason-The others might not make a full effort to hear and understand me",
        text: "The others might not make a full effort to hear and understand me",
      },
      {
        value:
          "unwillingness-reason-I don’t often participate in conversations like these",
        text: "I don’t often participate in conversations like these",
      },
      {
        value: "unwillingness-reason-The conversation could become awkward or tense",
        text: "The conversation could become awkward or tense",
      },
      {
        value: "unwillingness-reason-The conversation could negatively affect how I feel about myself during and/or afterward (e.g.,  fear, sadness, anger, vulnerability)",
        text: "The conversation could negatively affect how I feel about myself during and/or afterward (e.g.,  fear, sadness, anger, vulnerability)",
      },
      {
        value: "unwillingness-reason-The conversation could negatively affect how I feel about the world during and/or afterward",
        text: "The conversation could negatively affect how I feel about the world during and/or afterward",
      },
      {
        value: "unwillingness-reason-Someone might take offense to what I say",
        text: "Someone might take offense to what I say",
      },
      {
        value: "unwillingness-reason-I might take offense to what someone says",
        text: "I might take offense to what someone says",
      },
      {
        value: "unwillingness-reason-I might feel disempowered, unheard, or invalidated",
        text: "I might feel disempowered, unheard, or invalidated",
      },
      {
        value: "unwillingness-reason-I would not trust the others to keep the conversation productive and respectful (e.g., keeping emotions in check, refraining from making hostile remarks, not dominating the conversation)",
        text: "I would not trust the others to keep the conversation productive and respectful (e.g., keeping emotions in check, refraining from making hostile remarks, not dominating the conversation)",
      },
      {
        value: "unwillingness-reason-I might struggle to remain productive and respectful",
        text: "I might struggle to remain productive and respectful",
      },
      {
        value: "unwillingness-reason-I would not want to listen to the others discuss their views",
        text: "I would not want to listen to the others discuss their views",
      },
      {
        value: "unwillingness-reason-It would be a waste of time because my views wouldn't change",
        text: "It would be a waste of time because my views wouldn't change",
      },
      {
        value: "unwillingness-reason-I would feel like the topic is too complex or requires more knowledge than I have",
        text: "I would feel like the topic is too complex or requires more knowledge than I have",
      },
      {
        value: "unwillingness-reason-I don't have first-hand experience with the topic and/or it isn't relevant to me",
        text: "I don't have first-hand experience with the topic and/or it isn't relevant to me",
      },
      {
        value: "unwillingness-reason-I could experience significant repercussions at work or in other spaces beyond my personal social network",
        text: "I could experience significant repercussions at work or in other spaces beyond my personal social network",
      },
      {
        value: "unwillingness-reason-It wouldn't be worth the emotional and/or mental energy",
        text: "It wouldn't be worth the emotional and/or mental energy",
      },
      {
        value: "unwillingness-reason-It would be a waste of time because the others' views wouldn't change",
        text: "It would be a waste of time because the others' views wouldn't change",
      },
      {
        value: "unwillingness-reason-I would not want to hurt my relationship(s) with others or upset them",
        text: "I would not want to hurt my relationship(s) with others or upset them",
      }
    ];

    // define some stuff first so we can extract from gen_willingness_openmindedness_survey and use in follow up survey 
    let polarizedStatement;
    window.followUpRows = [];
    let followUpRows = [];

    var gen_willingness_openmindedness_survey = {
      data: {
        phase: "gen-willingness-openmindedness-survey",
      },
      type: jsPsychSurvey,
      survey_function: initializePreSlider,
      survey_json: () => {
        console.log("Follow-up rows at runtime:", window.followUpRows); // debug
        const topic = topicChoice; // get topic choice
        var gen_willingness_openmindedness_survey_inner_var = {
          elements: [
            {
              type: "matrix",
              name: "openmindedness",
              title:
                `Rate the following statements on the seven point scale: When I have conversations about ${topic}, I...`,
              isRequired: true,
              columns: [
                {
                  value: 1,
                  text: "Disagree strongly",
                },
                {
                  value: 2,
                  text: "Disagree moderately",
                },
                {
                  value: 3,
                  text: "Disagree a little",
                },
                {
                  value: 4,
                  text: "Neither agree nor disagree",
                },
                {
                  value: 5,
                  text: "Agree a little",
                },
                {
                  value: 6,
                  text: "Agree moderately",
                },
                {
                  value: 7,
                  text: "Agree strongly",
                },
              ],
              rows: [
                {
                  value:
                    "openmindedness...have little patience for arguments that I disagree with @R@",
                  text: `...have little patience for arguments that I disagree with`,
                },
                {
                  value:
                    "openmindedness...avoid messages that I disagree with @R@",
                  text: `...avoid messages that I disagree with`,
                },
                {
                  value:
                    "openmindedness...believe it is a waste of time to pay attention to certain political ideas about ${topic} @R@",
                  text: `...believe it is a waste of time to pay attention to certain political ideas on the topic`,
                },
                {
                  value:
                    "openmindedness...am open to considering other political viewpoints about ${topic}",
                  text: `...am open to considering other political viewpoints`,
                },
                {
                  value:
                    "openmindedness...consider as many different opinions as possible about ${topic}",
                  text: `...consider as many different opinions as possible`,
                },
              ],
            },
            {
              type: "expression",
              name: "slider1",
              title:
                `Using the slider, please rate your willingness to have a conversation with someone who strongly disagrees with you about ${topic}, where a score of 0 is absolute unwillingness to converse and 100 is absolute willingness to converse. A score of 50 is neutral.`,
            },
            {
              type: "html",
              name: "slider1-placeholder",
              isRequired: true,
              title:
                "Using the slider, please rate your willingness to have a conversation with someone who strongly disagrees with you about ${topic}, where a score of 0 is absolute unwillingness to converse and 100 is absolute willingness to converse. A score of 50 is neutral.",
              html: '<div id="slider1-placeholder"></div>', // Placeholder for the slider
            },
            {
              type: "expression",
              name: "slider2",
              title:
                `Using the slider, please rate your willingness to have a conversation with someone who would push against your views about ${topic}, where 0 is absolute unwillingness and 100 is absolute willingness.`,
            },
            {
              type: "html",
              name: "slider2-placeholder",
              isRequired: true,
              title:
                "Using the slider, please rate your willingness to have a conversation with someone who would push against your views about ${topic}, where 0 is absolute unwillingness and 100 is absolute willingness.",
              html: '<div id="slider2-placeholder"></div>', // Placeholder for the slider
            },
            {
              type: "expression",
              name: "attention-check-slider",
              title: `Using the slider, please move the slider all the way to the left to the zero value. This is a question to assess whether you are attending to the instructions.`,
            },
            {
              type: "html",
              name: "attention-check-slider-pre-placeholder",
              isRequired: true,
              title: "Using the slider, please move the slider all the way to the left to the zero value. This is a question to assess whether you are attending to the instructions.",
              html: '<div id="attention-check-slider-pre-placeholder"></div>', // Placeholder for the slider
            },
          ],
        };
        return gen_willingness_openmindedness_survey_inner_var
      },
      survey_function: initializePreSlider,
    };


    var unwillingness_concerns_first_survey = {
      data: {
        phase: "willingness-concerns-first-survey",
      },
      type: jsPsychSurvey,
      survey_function: initializePreSlider,
      survey_json: () => {
        console.log("Follow-up rows at runtime:", window.followUpRows); // debug
        const topic = topicChoice; // get topic choice
        var unwillingness_concerns_first_survey_inner_var = {
          elements: [
            {
              type: "matrix",
              name: "unwillingness-reason",
              title:
                `Imagine you're asked to have a serious conversation about ${topic} with a group of people who mostly hold differing views from yours. Below is a list of potential concerns that you might have in the conversation. For each item, select Yes if it would concern you, even a little bit; otherwise, select No. (You may reflect on past experiences you've had in similar situations.)`,
              isRequired: true,
              columns: [
                {
                  value: 1,
                  text: "Yes",
                },
                {
                  value: 2,
                  text: "No",
                },
              ],
              rows: unwillingness_concern_rows,
              rowsOrder: "random",
            },
          ],
        };
        return unwillingness_concerns_first_survey_inner_var
      },
      on_finish: function (data) {
        let responses = data.response; // already an object
        let unwillingnessAnswers = responses["unwillingness-reason"];

        let yesRows = unwillingness_concern_rows.filter(row => unwillingnessAnswers[row.value] == 1);

        jsPsych.data.addProperties({ unwillingness_yes_rows: yesRows });
        window.followUpRows = yesRows;
      }
    };

    var follow_up_unwillingness_concerns_survey = {
      data: {
        phase: "follow-up-unwillingness-concerns-survey",
      },
      type: jsPsychSurvey,
      survey_function: initializePreSlider,
      survey_json: () => {
        const topic = topicChoice; // get topic choice
        var follow_up_unwillingness_concerns_survey_inner_var = {
          elements: [
            {
              type: "matrix",
              name: "openmindedness",
              title: `Continue to imagine you're asked to have a serious conversation about ${topic} with a group of people who mostly hold differing views from yours. For each concern below, rate how much it would impact your willingness to engage, from “Not at all” to “Extremely.“ (You may reflect on past experiences you've had in similar situations.)`,
              isRequired: true,
              columns: [
                {
                  value: 1,
                  text: "Not at all",
                },
                {
                  value: 2,
                  text: "Slightly",
                },
                {
                  value: 3,
                  text: "Somewhat",
                },
                {
                  value: 4,
                  text: "Moderately",
                },
                {
                  value: 5,
                  text: "Quite a bit",
                },
                {
                  value: 6,
                  text: "Very much",
                },
                {
                  value: 7,
                  text: "Extremely",
                },
              ],
              rows: window.followUpRows || []
            }
          ]
        };
        return follow_up_unwillingness_concerns_survey_inner_var;
      }
    };

    var free_response_question_phase_survey = {
      data: {
        phase: "free-response-survey",
      },
      type: jsPsychSurvey,
      survey_function: initializePreSlider,
      survey_json: () => {
        const topic = topicChoice; // get topic choice
        var free_response_question_survey = {
          elements: [
            {
              type: "comment",
              name: "willingness-free-response",
              title:
                `Finally, think back to the last time you chose to not participate in a conversation about ${topic} or another topic you found uncomfortable to discuss. In the space below, please describe why you decided to not engage. Consider whether your reasons align with any of the potential concerns listed in this survey, or if you had different concerns.`,
              isRequired: true,
            },
          ]
        };
        return free_response_question_survey;
      }
    };


    //goodbye message and brief explanation to user about our experiment motive
    var goodbye = {
      data: {
        phase: "goodbye",
      },
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <p> You have completed the survey! Please save your data before closing the page. <p>
      `,
      choices: ['Save data'],
      post_trial_gap: 1000,
    };

    /* ------------- PUSHING TIMELINE FOR EACH CONDITION ----------------- */

    control_timeline.push(
      welcome,
      survey_trial,
      gen_willingness_openmindedness_survey,
      unwillingness_concerns_first_survey,
      follow_up_unwillingness_concerns_survey,
      free_response_question_phase_survey,
      goodbye
    )

    //SAVE EXPERIMENT DATA TO OSF via datapipe
    const save_data = {
      type: jsPsychPipe,
      action: "save",
      experiment_id: "P09AXWX5b5t6",
      filename: filename,
      data_string: () => jsPsych.data.get().csv()
    };

    createExperiment();


    //run experiment
    // jsPsych.run(timeline);

  </script>
</body>

</html>