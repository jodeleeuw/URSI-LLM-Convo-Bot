var jsPsychChat=function(e){"use strict";function t(e){var t,r;function o(t,r){try{var i=e[t](r),s=i.value,c=s instanceof n;Promise.resolve(c?s.v:s).then((function(n){if(c){var r="return"===t?"return":"next";if(!s.k||n.done)return o(r,n);n=e[r](n).value}a(i.done?"return":"normal",n)}),(function(e){o("throw",e)}))}catch(e){a("throw",e)}}function a(e,n){switch(e){case"return":t.resolve({value:n,done:!0});break;case"throw":t.reject(n);break;default:t.resolve({value:n,done:!1})}(t=t.next)?o(t.key,t.arg):r=null}this._invoke=function(e,n){return new Promise((function(a,i){var s={key:e,arg:n,resolve:a,reject:i,next:null};r?r=r.next=s:(t=r=s,o(e,n))}))},"function"!=typeof e.return&&(this.return=void 0)}function n(e,t){this.v=e,this.k=t}function r(e){var t,n,r,a=2;for("undefined"!=typeof Symbol&&(n=Symbol.asyncIterator,r=Symbol.iterator);a--;){if(n&&null!=(t=e[n]))return t.call(e);if(r&&null!=(t=e[r]))return new o(t.call(e));n="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function o(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return o=function(e){this.s=e,this.n=e.next},o.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var n=this.s.return;return void 0===n?Promise.resolve({value:e,done:!0}):t(n.apply(this.s,arguments))},throw:function(e){var n=this.s.return;return void 0===n?Promise.reject(e):t(n.apply(this.s,arguments))}},new o(e)}function a(e){return new n(e,0)}function i(e,t,n){return t=w(t),function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return P(e)}(e,s()?Reflect.construct(t,n||[],w(e).constructor):t.apply(e,n))}function s(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(s=function(){return!!e})()}function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){g(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(){l=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",c=a.toStringTag||"@@toStringTag";function u(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,n){return e[t]=n}}function f(e,t,n,r){var a=t&&t.prototype instanceof g?t:g,i=Object.create(a.prototype),s=new L(r||[]);return o(i,"_invoke",{value:T(e,n,s)}),i}function h(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=f;var p="suspendedStart",d="suspendedYield",m="executing",v="completed",y={};function g(){}function b(){}function w(){}var k={};u(k,i,(function(){return this}));var x=Object.getPrototypeOf,_=x&&x(x(M([])));_&&_!==n&&r.call(_,i)&&(k=_);var P=w.prototype=g.prototype=Object.create(k);function S(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function C(e,t){function n(o,a,i,s){var c=h(e[o],e,a);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==typeof l&&r.call(l,"__await")?t.resolve(l.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(l).then((function(e){u.value=e,i(u)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return a=a?a.then(o,o):o()}})}function T(t,n,r){var o=p;return function(a,i){if(o===m)throw new Error("Generator is already running");if(o===v){if("throw"===a)throw i;return{value:e,done:!0}}for(r.method=a,r.arg=i;;){var s=r.delegate;if(s){var c=E(s,r);if(c){if(c===y)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===p)throw o=v,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=m;var u=h(t,n,r);if("normal"===u.type){if(o=r.done?v:d,u.arg===y)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(o=v,r.method="throw",r.arg=u.arg)}}}function E(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,E(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),y;var a=h(o,t.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,y;var i=a.arg;return i?i.done?(n[t.resultName]=i.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,y):i:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,y)}function O(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function j(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function L(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(O,this),this.reset(!0)}function M(t){if(t||""===t){var n=t[i];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}throw new TypeError(typeof t+" is not iterable")}return b.prototype=w,o(P,"constructor",{value:w,configurable:!0}),o(w,"constructor",{value:b,configurable:!0}),b.displayName=u(w,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===b||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,w):(e.__proto__=w,u(e,c,"GeneratorFunction")),e.prototype=Object.create(P),e},t.awrap=function(e){return{__await:e}},S(C.prototype),u(C.prototype,s,(function(){return this})),t.AsyncIterator=C,t.async=function(e,n,r,o,a){void 0===a&&(a=Promise);var i=new C(f(e,n,r,o),a);return t.isGeneratorFunction(n)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},S(P),u(P,c,"Generator"),u(P,i,(function(){return this})),u(P,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=M,L.prototype={constructor:L,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(j),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return s.type="throw",s.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],s=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var c=r.call(i,"catchLoc"),u=r.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,y):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),y},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),j(n),y}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;j(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:M(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),y}},t}function f(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}function h(e){return function(){return new t(e.apply(this,arguments))}}function p(e,t,n,r,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}function d(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){p(a,r,o,i,s,"next",e)}function s(e){p(a,r,o,i,s,"throw",e)}i(void 0)}))}}function m(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function v(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,f(r.key),r)}}function y(e,t,n){return t&&v(e.prototype,t),n&&v(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function g(e,t,n){return(t=f(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function b(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&k(e,t)}function w(e){return w=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},w(e)}function k(e,t){return k=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},k(e,t)}function x(e){var t="function"==typeof Map?new Map:void 0;return x=function(e){if(null===e||!function(e){try{return-1!==Function.toString.call(e).indexOf("[native code]")}catch(t){return"function"==typeof e}}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return function(e,t,n){if(s())return Reflect.construct.apply(null,arguments);var r=[null];r.push.apply(r,t);var o=new(e.bind.apply(e,r));return n&&k(o,n.prototype),o}(e,arguments,w(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),k(n,e)},x(e)}function _(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}function P(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function S(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a,i,s=[],c=!0,u=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=a.call(n)).done)&&(s.push(r.value),s.length!==t);c=!0);}catch(e){u=!0,o=e}finally{try{if(!c&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(u)throw o}}return s}}(e,t)||T(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function C(e){return function(e){if(Array.isArray(e))return E(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||T(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function T(e,t){if(e){if("string"==typeof e)return E(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?E(e,t):void 0}}function E(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function O(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=T(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw a}}}}function j(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}c((r=r.apply(e,t||[])).next())}))}t.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)},"function"==typeof SuppressedError&&SuppressedError;var L=!1,M=void 0,N=void 0;var R=function(e){function t(e){m(this,t),this.body=e}return y(t,[{key:Symbol.toStringTag,get:function(){return"MultipartBody"}}]),t}();M||function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{auto:!1};if(L)throw new Error("you must `import 'openai/shims/".concat(e.kind,"'` before importing anything else from openai"));if(M)throw new Error("can't `import 'openai/shims/".concat(e.kind,"'` after `import 'openai/shims/").concat(M,"'`"));L=t.auto,M=e.kind,e.fetch,e.Request,e.Response,e.Headers,e.FormData,e.Blob,e.File,N=e.ReadableStream,e.getMultipartRequestOptions,e.getDefaultAgent,e.fileFromPath,e.isFsReadStream}(function(){var e,t,n,r,o,a=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).manuallyImported?"You may need to use polyfills":"Add one of these imports before your first `import â€¦ from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";try{e=fetch,t=Request,n=Response,r=Headers}catch(e){throw new Error("this environment is missing the following Web Fetch API type: ".concat(e.message,". ").concat(a))}return{kind:"web",fetch:e,Request:t,Response:n,Headers:r,FormData:"undefined"!=typeof FormData?FormData:y((function e(){throw m(this,e),new Error("file uploads aren't supported in this environment yet as 'FormData' is undefined. ".concat(a))})),Blob:"undefined"!=typeof Blob?Blob:y((function e(){throw m(this,e),new Error("file uploads aren't supported in this environment yet as 'Blob' is undefined. ".concat(a))})),File:"undefined"!=typeof File?File:y((function e(){throw m(this,e),new Error("file uploads aren't supported in this environment yet as 'File' is undefined. ".concat(a))})),ReadableStream:"undefined"!=typeof ReadableStream?ReadableStream:y((function e(){throw m(this,e),new Error("streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ".concat(a))})),getMultipartRequestOptions:(o=d(l().mark((function e(t,n){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",u(u({},n),{},{body:new R(t)}));case 1:case"end":return e.stop()}}),e)}))),function(e,t){return o.apply(this,arguments)}),getDefaultAgent:function(e){},fileFromPath:function(){throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:function(e){return!1}}}(),{auto:!0});var I=function(e){function t(e,n){m(this,t),this.iterator=e,this.controller=n}return y(t,[{key:Symbol.asyncIterator,value:function(){return this.iterator()}},{key:"tee",value:function(){var e=[],n=[],r=this.iterator(),o=function(t){return{next:function(){if(0===t.length){var o=r.next();e.push(o),n.push(o)}return t.shift()}}};return[new t((function(){return o(e)}),this.controller),new t((function(){return o(n)}),this.controller)]}},{key:"toReadableStream",value:function(){var e,t=this,n=new TextEncoder;return new N({start:function(){return d(l().mark((function n(){return l().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:e=t[Symbol.asyncIterator]();case 1:case"end":return n.stop()}}),n)})))()},pull:function(t){return d(l().mark((function r(){var o,a,i;return l().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,e.next();case 3:if(o=r.sent,a=o.value,!o.done){r.next=8;break}return r.abrupt("return",t.close());case 8:i=n.encode(JSON.stringify(a)+"\n"),t.enqueue(i),r.next=15;break;case 12:r.prev=12,r.t0=r.catch(0),t.error(r.t0);case 15:case"end":return r.stop()}}),r,null,[[0,12]])})))()},cancel:function(){return d(l().mark((function t(){var n,r;return l().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,null===(n=(r=e).return)||void 0===n?void 0:n.call(r);case 2:case"end":return t.stop()}}),t)})))()}})}}],[{key:"fromSSEResponse",value:function(e,n){var o=!1;function i(){return(i=h(l().mark((function t(){var i,s,c,u,f,h,p,d,m;return l().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!o){t.next=2;break}throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");case 2:o=!0,i=!1,t.prev=4,s=!1,c=!1,t.prev=7,f=r(A(e,n));case 9:return t.next=11,a(f.next());case 11:if(!(s=!(h=t.sent).done)){t.next=52;break}if(p=h.value,!i){t.next=15;break}return t.abrupt("continue",49);case 15:if(!p.data.startsWith("[DONE]")){t.next=18;break}return i=!0,t.abrupt("continue",49);case 18:if(null!==p.event){t.next=35;break}d=void 0,t.prev=20,d=JSON.parse(p.data),t.next=29;break;case 24:throw t.prev=24,t.t0=t.catch(20),console.error("Could not parse message into JSON:",p.data),console.error("From chunk:",p.raw),t.t0;case 29:if(!d||!d.error){t.next=31;break}throw new U(void 0,d.error,void 0,void 0);case 31:return t.next=33,d;case 33:t.next=49;break;case 35:m=void 0,t.prev=36,m=JSON.parse(p.data),t.next=45;break;case 40:throw t.prev=40,t.t1=t.catch(36),console.error("Could not parse message into JSON:",p.data),console.error("From chunk:",p.raw),t.t1;case 45:if("error"!=p.event){t.next=47;break}throw new U(void 0,m.error,m.message,void 0);case 47:return t.next=49,{event:p.event,data:m};case 49:s=!1,t.next=9;break;case 52:t.next=58;break;case 54:t.prev=54,t.t2=t.catch(7),c=!0,u=t.t2;case 58:if(t.prev=58,t.prev=59,!s||null==f.return){t.next=63;break}return t.next=63,a(f.return());case 63:if(t.prev=63,!c){t.next=66;break}throw u;case 66:return t.finish(63);case 67:return t.finish(58);case 68:i=!0,t.next=76;break;case 71:if(t.prev=71,t.t3=t.catch(4),!(t.t3 instanceof Error&&"AbortError"===t.t3.name)){t.next=75;break}return t.abrupt("return");case 75:throw t.t3;case 76:return t.prev=76,i||n.abort(),t.finish(76);case 79:case"end":return t.stop()}}),t,null,[[4,71,76,79],[7,54,58,68],[20,24],[36,40],[59,,63,67]])})))).apply(this,arguments)}return new t((function(){return i.apply(this,arguments)}),n)}},{key:"fromReadableStream",value:function(e,n){var o=!1;function i(){return s.apply(this,arguments)}function s(){return(s=h(l().mark((function t(){var n,o,i,s,c,u,f,h,p,d,m,v,y,g;return l().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=new J,o=H(e),i=!1,s=!1,t.prev=4,u=r(o);case 6:return t.next=8,a(u.next());case 8:if(!(i=!(f=t.sent).done)){t.next=30;break}h=f.value,p=O(n.decode(h)),t.prev=11,p.s();case 13:if((d=p.n()).done){t.next=19;break}return m=d.value,t.next=17,m;case 17:t.next=13;break;case 19:t.next=24;break;case 21:t.prev=21,t.t0=t.catch(11),p.e(t.t0);case 24:return t.prev=24,p.f(),t.finish(24);case 27:i=!1,t.next=6;break;case 30:t.next=36;break;case 32:t.prev=32,t.t1=t.catch(4),s=!0,c=t.t1;case 36:if(t.prev=36,t.prev=37,!i||null==u.return){t.next=41;break}return t.next=41,a(u.return());case 41:if(t.prev=41,!s){t.next=44;break}throw c;case 44:return t.finish(41);case 45:return t.finish(36);case 46:v=O(n.flush()),t.prev=47,v.s();case 49:if((y=v.n()).done){t.next=55;break}return g=y.value,t.next=53,g;case 53:t.next=49;break;case 55:t.next=60;break;case 57:t.prev=57,t.t2=t.catch(47),v.e(t.t2);case 60:return t.prev=60,v.f(),t.finish(60);case 63:case"end":return t.stop()}}),t,null,[[4,32,36,46],[11,21,24,27],[37,,41,45],[47,57,60,63]])})))).apply(this,arguments)}function c(){return(c=h(l().mark((function e(){var t,s,c,u,f,h,p;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!o){e.next=2;break}throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");case 2:o=!0,t=!1,e.prev=4,s=!1,c=!1,e.prev=7,f=r(i());case 9:return e.next=11,a(f.next());case 11:if(!(s=!(h=e.sent).done)){e.next=21;break}if(p=h.value,!t){e.next=15;break}return e.abrupt("continue",18);case 15:if(!p){e.next=18;break}return e.next=18,JSON.parse(p);case 18:s=!1,e.next=9;break;case 21:e.next=27;break;case 23:e.prev=23,e.t0=e.catch(7),c=!0,u=e.t0;case 27:if(e.prev=27,e.prev=28,!s||null==f.return){e.next=32;break}return e.next=32,a(f.return());case 32:if(e.prev=32,!c){e.next=35;break}throw u;case 35:return e.finish(32);case 36:return e.finish(27);case 37:t=!0,e.next=45;break;case 40:if(e.prev=40,e.t1=e.catch(4),!(e.t1 instanceof Error&&"AbortError"===e.t1.name)){e.next=44;break}return e.abrupt("return");case 44:throw e.t1;case 45:return e.prev=45,t||n.abort(),e.finish(45);case 48:case"end":return e.stop()}}),e,null,[[4,40,45,48],[7,23,27,37],[28,,32,36]])})))).apply(this,arguments)}return new t((function(){return c.apply(this,arguments)}),n)}}]),t}();function A(e,t){return F.apply(this,arguments)}function F(){return(F=h(l().mark((function e(t,n){var o,i,s,c,u,f,h,p,d,m,v,y,g,b,w,k,x;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.body){e.next=3;break}throw n.abort(),new B("Attempted to iterate over a response with no body");case 3:o=new q,i=new J,s=H(t.body),c=!1,u=!1,e.prev=8,h=r(G(s));case 10:return e.next=12,a(h.next());case 12:if(!(c=!(p=e.sent).done)){e.next=36;break}d=p.value,m=O(i.decode(d)),e.prev=15,m.s();case 17:if((v=m.n()).done){e.next=25;break}if(y=v.value,!(g=o.decode(y))){e.next=23;break}return e.next=23,g;case 23:e.next=17;break;case 25:e.next=30;break;case 27:e.prev=27,e.t0=e.catch(15),m.e(e.t0);case 30:return e.prev=30,m.f(),e.finish(30);case 33:c=!1,e.next=10;break;case 36:e.next=42;break;case 38:e.prev=38,e.t1=e.catch(8),u=!0,f=e.t1;case 42:if(e.prev=42,e.prev=43,!c||null==h.return){e.next=47;break}return e.next=47,a(h.return());case 47:if(e.prev=47,!u){e.next=50;break}throw f;case 50:return e.finish(47);case 51:return e.finish(42);case 52:b=O(i.flush()),e.prev=53,b.s();case 55:if((w=b.n()).done){e.next=63;break}if(k=w.value,!(x=o.decode(k))){e.next=61;break}return e.next=61,x;case 61:e.next=55;break;case 63:e.next=68;break;case 65:e.prev=65,e.t2=e.catch(53),b.e(e.t2);case 68:return e.prev=68,b.f(),e.finish(68);case 71:case"end":return e.stop()}}),e,null,[[8,38,42,52],[15,27,30,33],[43,,47,51],[53,65,68,71]])})))).apply(this,arguments)}function G(e){return W.apply(this,arguments)}function W(){return(W=h(l().mark((function e(t){var n,o,i,s,c,u,f,h,p,d;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=new Uint8Array,o=!1,i=!1,e.prev=3,c=r(t);case 5:return e.next=7,a(c.next());case 7:if(!(o=!(u=e.sent).done)){e.next=26;break}if(null!=(f=u.value)){e.next=11;break}return e.abrupt("continue",23);case 11:h=f instanceof ArrayBuffer?new Uint8Array(f):"string"==typeof f?(new TextEncoder).encode(f):f,(p=new Uint8Array(n.length+h.length)).set(n),p.set(h,n.length),n=p,d=void 0;case 17:if(-1===(d=D(n))){e.next=23;break}return e.next=20,n.slice(0,d);case 20:n=n.slice(d),e.next=17;break;case 23:o=!1,e.next=5;break;case 26:e.next=32;break;case 28:e.prev=28,e.t0=e.catch(3),i=!0,s=e.t0;case 32:if(e.prev=32,e.prev=33,!o||null==c.return){e.next=37;break}return e.next=37,a(c.return());case 37:if(e.prev=37,!i){e.next=40;break}throw s;case 40:return e.finish(37);case 41:return e.finish(32);case 42:if(!(n.length>0)){e.next=45;break}return e.next=45,n;case 45:case"end":return e.stop()}}),e,null,[[3,28,32,42],[33,,37,41]])})))).apply(this,arguments)}function D(e){for(var t=0;t<e.length-2;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}var q=function(){function e(){m(this,e),this.event=null,this.data=[],this.chunks=[]}return y(e,[{key:"decode",value:function(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;var t={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],t}if(this.chunks.push(e),e.startsWith(":"))return null;var n=function(e,t){var n=e.indexOf(t);if(-1!==n)return[e.substring(0,n),t,e.substring(n+t.length)];return[e,"",""]}(e,":"),r=S(n,3),o=r[0];r[1];var a=r[2];return a.startsWith(" ")&&(a=a.substring(1)),"event"===o?this.event=a:"data"===o&&this.data.push(a),null}}]),e}(),J=function(){function e(){m(this,e),this.buffer=[],this.trailingCR=!1}return y(e,[{key:"decode",value:function(t){var n=this.decodeText(t);if(this.trailingCR&&(n="\r"+n,this.trailingCR=!1),n.endsWith("\r")&&(this.trailingCR=!0,n=n.slice(0,-1)),!n)return[];var r=e.NEWLINE_CHARS.has(n[n.length-1]||""),o=n.split(e.NEWLINE_REGEXP);return r&&o.pop(),1!==o.length||r?(this.buffer.length>0&&(o=[this.buffer.join("")+o[0]].concat(C(o.slice(1))),this.buffer=[]),r||(this.buffer=[o.pop()||""]),o):(this.buffer.push(o[0]),[])}},{key:"decodeText",value:function(e){if(null==e)return"";if("string"==typeof e)return e;if("undefined"!=typeof Buffer){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new B("Unexpected: received non-Uint8Array (".concat(e.constructor.name,') stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.'))}if("undefined"!=typeof TextDecoder){var t;if(e instanceof Uint8Array||e instanceof ArrayBuffer)return null!==(t=this.textDecoder)&&void 0!==t||(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new B("Unexpected: received non-Uint8Array/ArrayBuffer (".concat(e.constructor.name,") in a web platform. Please report this error."))}throw new B("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}},{key:"flush",value:function(){if(!this.buffer.length&&!this.trailingCR)return[];var e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}]),e}();function H(e){if(e[Symbol.asyncIterator])return e;var t=e.getReader();return g({next:function(){return d(l().mark((function e(){var n;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.read();case 3:return null!=(n=e.sent)&&n.done&&t.releaseLock(),e.abrupt("return",n);case 8:throw e.prev=8,e.t0=e.catch(0),t.releaseLock(),e.t0;case 12:case"end":return e.stop()}}),e,null,[[0,8]])})))()},return:function(){return d(l().mark((function e(){var n;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.cancel(),t.releaseLock(),e.next=4,n;case 4:return e.abrupt("return",{done:!0,value:void 0});case 5:case"end":return e.stop()}}),e)})))()}},Symbol.asyncIterator,(function(){return this}))}J.NEWLINE_CHARS=new Set(["\n","\r"]),J.NEWLINE_REGEXP=/\r\n|[\n\r]/g;var B=function(e){function t(){return m(this,t),i(this,t,arguments)}return b(t,e),y(t)}(x(Error)),U=function(e){function t(e,n,r,o){var a;m(this,t),(a=i(this,t,["".concat(t.makeMessage(e,n,r))])).status=e,a.headers=o,a.request_id=null==o?void 0:o["x-request-id"];var s=n;return a.error=s,a.code=null==s?void 0:s.code,a.param=null==s?void 0:s.param,a.type=null==s?void 0:s.type,a}return b(t,e),y(t,null,[{key:"makeMessage",value:function(e,t,n){var r=null!=t&&t.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&r?"".concat(e," ").concat(r):e?"".concat(e," status code (no body)"):r||"(no status code or body)"}},{key:"generate",value:function(e,n,r,o){if(!e)return new Y({cause:(a=n,a instanceof Error?a:new Error(a))});var a,i=null==n?void 0:n.error;return 400===e?new z(e,i,r,o):401===e?new V(e,i,r,o):403===e?new K(e,i,r,o):404===e?new $(e,i,r,o):409===e?new Q(e,i,r,o):422===e?new Z(e,i,r,o):429===e?new ee(e,i,r,o):e>=500?new te(e,i,r,o):new t(e,i,r,o)}}]),t}(B),X=function(e){function t(){var e,n=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).message;return m(this,t),(e=i(this,t,[void 0,void 0,n||"Request was aborted.",void 0])).status=void 0,e}return b(t,e),y(t)}(U),Y=function(e){function t(e){var n,r=e.message,o=e.cause;return m(this,t),(n=i(this,t,[void 0,void 0,r||"Connection error.",void 0])).status=void 0,o&&(n.cause=o),n}return b(t,e),y(t)}(U),z=function(e){function t(){var e;return m(this,t),(e=i(this,t,arguments)).status=400,e}return b(t,e),y(t)}(U),V=function(e){function t(){var e;return m(this,t),(e=i(this,t,arguments)).status=401,e}return b(t,e),y(t)}(U),K=function(e){function t(){var e;return m(this,t),(e=i(this,t,arguments)).status=403,e}return b(t,e),y(t)}(U),$=function(e){function t(){var e;return m(this,t),(e=i(this,t,arguments)).status=404,e}return b(t,e),y(t)}(U),Q=function(e){function t(){var e;return m(this,t),(e=i(this,t,arguments)).status=409,e}return b(t,e),y(t)}(U),Z=function(e){function t(){var e;return m(this,t),(e=i(this,t,arguments)).status=422,e}return b(t,e),y(t)}(U),ee=function(e){function t(){var e;return m(this,t),(e=i(this,t,arguments)).status=429,e}return b(t,e),y(t)}(U),te=function(e){function t(){return m(this,t),i(this,t,arguments)}return b(t,e),y(t)}(U);function ne(e){return"function"==typeof e.parse}var re,oe,ae,ie,se,ce,ue,le,fe,he,pe,de,me,ve,ye,ge,be,we,ke,xe,_e=function(e){return"assistant"===(null==e?void 0:e.role)},Pe=function(e){return"function"===(null==e?void 0:e.role)},Se=function(e){return"tool"===(null==e?void 0:e.role)},Ce=["function_call","stream"],Te=["tool_choice","stream"],Ee=function(e,t,n,r,o){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?o.call(e,n):o?o.value=n:t.set(e,n),n},Oe=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)},je=function(){function e(){var t=this;m(this,e),re.add(this),this.controller=new AbortController,oe.set(this,void 0),ae.set(this,(function(){})),ie.set(this,(function(){})),se.set(this,void 0),ce.set(this,(function(){})),ue.set(this,(function(){})),le.set(this,{}),this._chatCompletions=[],this.messages=[],fe.set(this,!1),he.set(this,!1),pe.set(this,!1),de.set(this,!1),we.set(this,(function(e){if(Ee(t,he,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new X),e instanceof X)return Ee(t,pe,!0,"f"),t._emit("abort",e);if(e instanceof B)return t._emit("error",e);if(e instanceof Error){var n=new B(e.message);return n.cause=e,t._emit("error",n)}return t._emit("error",new B(String(e)))})),Ee(this,oe,new Promise((function(e,n){Ee(t,ae,e,"f"),Ee(t,ie,n,"f")})),"f"),Ee(this,se,new Promise((function(e,n){Ee(t,ce,e,"f"),Ee(t,ue,n,"f")})),"f"),Oe(this,oe,"f").catch((function(){})),Oe(this,se,"f").catch((function(){}))}var t,n,r,o,a,i,s,c,f,h,p;return y(e,[{key:"_run",value:function(e){var t=this;setTimeout((function(){e().then((function(){t._emitFinal(),t._emit("end")}),Oe(t,we,"f"))}),0)}},{key:"_addChatCompletion",value:function(e){var t;this._chatCompletions.push(e),this._emit("chatCompletion",e);var n=null===(t=e.choices[0])||void 0===t?void 0:t.message;return n&&this._addMessage(n),e}},{key:"_addMessage",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),(Pe(e)||Se(e))&&e.content)this._emit("functionCallResult",e.content);else if(_e(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(_e(e)&&e.tool_calls){var n,r=O(e.tool_calls);try{for(r.s();!(n=r.n()).done;){var o=n.value;"function"===o.type&&this._emit("functionCall",o.function)}}catch(e){r.e(e)}finally{r.f()}}}},{key:"_connected",value:function(){this.ended||(Oe(this,ae,"f").call(this),this._emit("connect"))}},{key:"ended",get:function(){return Oe(this,fe,"f")}},{key:"errored",get:function(){return Oe(this,he,"f")}},{key:"aborted",get:function(){return Oe(this,pe,"f")}},{key:"abort",value:function(){this.controller.abort()}},{key:"on",value:function(e,t){return(Oe(this,le,"f")[e]||(Oe(this,le,"f")[e]=[])).push({listener:t}),this}},{key:"off",value:function(e,t){var n=Oe(this,le,"f")[e];if(!n)return this;var r=n.findIndex((function(e){return e.listener===t}));return r>=0&&n.splice(r,1),this}},{key:"once",value:function(e,t){return(Oe(this,le,"f")[e]||(Oe(this,le,"f")[e]=[])).push({listener:t,once:!0}),this}},{key:"emitted",value:function(e){var t=this;return new Promise((function(n,r){Ee(t,de,!0,"f"),"error"!==e&&t.once("error",r),t.once(e,n)}))}},{key:"done",value:(p=d(l().mark((function e(){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Ee(this,de,!0,"f"),e.next=3,Oe(this,se,"f");case 3:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"finalChatCompletion",value:(h=d(l().mark((function e(){var t;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.done();case 2:if(t=this._chatCompletions[this._chatCompletions.length-1]){e.next=5;break}throw new B("stream ended without producing a ChatCompletion");case 5:return e.abrupt("return",t);case 6:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"finalContent",value:(f=d(l().mark((function e(){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.done();case 2:return e.abrupt("return",Oe(this,re,"m",me).call(this));case 3:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"finalMessage",value:(c=d(l().mark((function e(){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.done();case 2:return e.abrupt("return",Oe(this,re,"m",ve).call(this));case 3:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"finalFunctionCall",value:(s=d(l().mark((function e(){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.done();case 2:return e.abrupt("return",Oe(this,re,"m",ye).call(this));case 3:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"finalFunctionCallResult",value:(i=d(l().mark((function e(){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.done();case 2:return e.abrupt("return",Oe(this,re,"m",ge).call(this));case 3:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"totalUsage",value:(a=d(l().mark((function e(){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.done();case 2:return e.abrupt("return",Oe(this,re,"m",be).call(this));case 3:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"allChatCompletions",value:function(){return C(this._chatCompletions)}},{key:"_emit",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];if(!Oe(this,fe,"f")){"end"===e&&(Ee(this,fe,!0,"f"),Oe(this,ce,"f").call(this));var o=Oe(this,le,"f")[e];if(o&&(Oe(this,le,"f")[e]=o.filter((function(e){return!e.once})),o.forEach((function(e){return e.listener.apply(void 0,n)}))),"abort"===e){var a=n[0];return Oe(this,de,"f")||null!=o&&o.length||Promise.reject(a),Oe(this,ie,"f").call(this,a),Oe(this,ue,"f").call(this,a),void this._emit("end")}if("error"===e){var i=n[0];Oe(this,de,"f")||null!=o&&o.length||Promise.reject(i),Oe(this,ie,"f").call(this,i),Oe(this,ue,"f").call(this,i),this._emit("end")}}}},{key:"_emitFinal",value:function(){var e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);var t=Oe(this,re,"m",ve).call(this);t&&this._emit("finalMessage",t);var n=Oe(this,re,"m",me).call(this);n&&this._emit("finalContent",n);var r=Oe(this,re,"m",ye).call(this);r&&this._emit("finalFunctionCall",r);var o=Oe(this,re,"m",ge).call(this);null!=o&&this._emit("finalFunctionCallResult",o),this._chatCompletions.some((function(e){return e.usage}))&&this._emit("totalUsage",Oe(this,re,"m",be).call(this))}},{key:"_createChatCompletion",value:(o=d(l().mark((function e(t,n,r){var o,a,i=this;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(o=null==r?void 0:r.signal)&&(o.aborted&&this.controller.abort(),o.addEventListener("abort",(function(){return i.controller.abort()}))),Oe(this,re,"m",ke).call(this,n),e.next=5,t.create(u(u({},n),{},{stream:!1}),u(u({},r),{},{signal:this.controller.signal}));case 5:return a=e.sent,this._connected(),e.abrupt("return",this._addChatCompletion(a));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return o.apply(this,arguments)})},{key:"_runChatCompletion",value:(r=d(l().mark((function e(t,n,r){var o,a,i;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=O(n.messages);try{for(o.s();!(a=o.n()).done;)i=a.value,this._addMessage(i,!1)}catch(e){o.e(e)}finally{o.f()}return e.next=4,this._createChatCompletion(t,n,r);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"_runFunctions",value:(n=d(l().mark((function e(t,n,r){var o,a,i,s,c,f,h,p,d,m,v,y,g,b,w,k,x,P,S,T,E,j,L,M,N,R,I,A;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o="function",a=n.function_call,i=void 0===a?"auto":a,n.stream,s=_(n,Ce),c="string"!=typeof i&&(null==i?void 0:i.name),f=(r||{}).maxChatCompletions,h=void 0===f?10:f,p={},d=O(n.functions);try{for(d.s();!(m=d.n()).done;)v=m.value,p[v.name||v.function.name]=v}catch(e){d.e(e)}finally{d.f()}y=n.functions.map((function(e){return{name:e.name||e.function.name,parameters:e.parameters,description:e.description}})),g=O(n.messages);try{for(g.s();!(b=g.n()).done;)w=b.value,this._addMessage(w,!1)}catch(e){g.e(e)}finally{g.f()}k=0;case 11:if(!(k<h)){e.next=58;break}return e.next=14,this._createChatCompletion(t,u(u({},s),{},{function_call:i,functions:y,messages:C(this.messages)}),r);case 14:if(P=e.sent,S=null===(x=P.choices[0])||void 0===x?void 0:x.message){e.next=18;break}throw new B("missing message in ChatCompletion response");case 18:if(S.function_call){e.next=20;break}return e.abrupt("return");case 20:if(T=S.function_call,E=T.name,j=T.arguments,L=p[E]){e.next=28;break}return M="Invalid function_call: ".concat(JSON.stringify(E),". Available options are: ").concat(y.map((function(e){return JSON.stringify(e.name)})).join(", "),". Please try again"),this._addMessage({role:o,name:E,content:M}),e.abrupt("continue",55);case 28:if(!c||c===E){e.next=32;break}return N="Invalid function_call: ".concat(JSON.stringify(E),". ").concat(JSON.stringify(c)," requested. Please try again"),this._addMessage({role:o,name:E,content:N}),e.abrupt("continue",55);case 32:if(R=void 0,e.prev=33,!ne(L)){e.next=40;break}return e.next=37,L.parse(j);case 37:e.t0=e.sent,e.next=41;break;case 40:e.t0=j;case 41:R=e.t0,e.next=48;break;case 44:return e.prev=44,e.t1=e.catch(33),this._addMessage({role:o,name:E,content:e.t1 instanceof Error?e.t1.message:String(e.t1)}),e.abrupt("continue",55);case 48:return e.next=50,L.function(R,this);case 50:if(I=e.sent,A=Oe(this,re,"m",xe).call(this,I),this._addMessage({role:o,name:E,content:A}),!c){e.next=55;break}return e.abrupt("return");case 55:++k,e.next=11;break;case 58:case"end":return e.stop()}}),e,this,[[33,44]])}))),function(e,t,r){return n.apply(this,arguments)})},{key:"_runTools",value:(t=d(l().mark((function e(t,n,r){var o,a,i,s,c,f,h,p,d,m,v,y,g,b,w,k,x,P,S,T,E,j,L,M,N,R,I,A,F,G,W,D,q,J;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a="tool",i=n.tool_choice,s=void 0===i?"auto":i,n.stream,c=_(n,Te),f="string"!=typeof s&&(null==s||null===(o=s.function)||void 0===o?void 0:o.name),h=(r||{}).maxChatCompletions,p=void 0===h?10:h,d={},m=O(n.tools);try{for(m.s();!(v=m.n()).done;)"function"===(y=v.value).type&&(d[y.function.name||y.function.function.name]=y.function)}catch(e){m.e(e)}finally{m.f()}g="tools"in n?n.tools.map((function(e){return"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description}}:e})):void 0,b=O(n.messages);try{for(b.s();!(w=b.n()).done;)k=w.value,this._addMessage(k,!1)}catch(e){b.e(e)}finally{b.f()}x=0;case 11:if(!(x<p)){e.next=77;break}return e.next=14,this._createChatCompletion(t,u(u({},c),{},{tool_choice:s,tools:g,messages:C(this.messages)}),r);case 14:if(S=e.sent,T=null===(P=S.choices[0])||void 0===P?void 0:P.message){e.next=18;break}throw new B("missing message in ChatCompletion response");case 18:if(T.tool_calls){e.next=20;break}return e.abrupt("return");case 20:E=O(T.tool_calls),e.prev=21,E.s();case 23:if((j=E.n()).done){e.next=66;break}if("function"===(L=j.value).type){e.next=27;break}return e.abrupt("continue",64);case 27:if(M=L.id,N=L.function,R=N.name,I=N.arguments,A=d[R]){e.next=36;break}return F="Invalid tool_call: ".concat(JSON.stringify(R),". Available options are: ").concat(g.map((function(e){return JSON.stringify(e.function.name)})).join(", "),". Please try again"),this._addMessage({role:a,tool_call_id:M,content:F}),e.abrupt("continue",64);case 36:if(!f||f===R){e.next=40;break}return G="Invalid tool_call: ".concat(JSON.stringify(R),". ").concat(JSON.stringify(f)," requested. Please try again"),this._addMessage({role:a,tool_call_id:M,content:G}),e.abrupt("continue",64);case 40:if(W=void 0,e.prev=41,!ne(A)){e.next=48;break}return e.next=45,A.parse(I);case 45:e.t0=e.sent,e.next=49;break;case 48:e.t0=I;case 49:W=e.t0,e.next=57;break;case 52:return e.prev=52,e.t1=e.catch(41),D=e.t1 instanceof Error?e.t1.message:String(e.t1),this._addMessage({role:a,tool_call_id:M,content:D}),e.abrupt("continue",64);case 57:return e.next=59,A.function(W,this);case 59:if(q=e.sent,J=Oe(this,re,"m",xe).call(this,q),this._addMessage({role:a,tool_call_id:M,content:J}),!f){e.next=64;break}return e.abrupt("return");case 64:e.next=23;break;case 66:e.next=71;break;case 68:e.prev=68,e.t2=e.catch(21),E.e(e.t2);case 71:return e.prev=71,E.f(),e.finish(71);case 74:++x,e.next=11;break;case 77:return e.abrupt("return");case 78:case"end":return e.stop()}}),e,this,[[21,68,71,74],[41,52]])}))),function(e,n,r){return t.apply(this,arguments)})}]),e}();oe=new WeakMap,ae=new WeakMap,ie=new WeakMap,se=new WeakMap,ce=new WeakMap,ue=new WeakMap,le=new WeakMap,fe=new WeakMap,he=new WeakMap,pe=new WeakMap,de=new WeakMap,we=new WeakMap,re=new WeakSet,me=function(){var e;return null!==(e=Oe(this,re,"m",ve).call(this).content)&&void 0!==e?e:null},ve=function(){for(var e=this.messages.length;e-- >0;){var t,n=this.messages[e];if(_e(n))return u(u({},n),{},{content:null!==(t=n.content)&&void 0!==t?t:null})}throw new B("stream ended without producing a ChatCompletionMessage with role=assistant")},ye=function(){for(var e=this.messages.length-1;e>=0;e--){var t,n,r=this.messages[e];if(_e(r)&&null!=r&&r.function_call)return r.function_call;if(_e(r)&&null!=r&&null!==(t=r.tool_calls)&&void 0!==t&&t.length)return null===(n=r.tool_calls.at(-1))||void 0===n?void 0:n.function}},ge=function(){for(var e,t=this,n=function(){var e=t.messages[r];return Pe(e)&&null!=e.content||Se(e)&&null!=e.content&&t.messages.some((function(t){var n;return"assistant"===t.role&&(null===(n=t.tool_calls)||void 0===n?void 0:n.some((function(t){return"function"===t.type&&t.id===e.tool_call_id})))}))?{v:e.content}:void 0},r=this.messages.length-1;r>=0;r--)if(e=n())return e.v},be=function(){var e,t={completion_tokens:0,prompt_tokens:0,total_tokens:0},n=O(this._chatCompletions);try{for(n.s();!(e=n.n()).done;){var r=e.value.usage;r&&(t.completion_tokens+=r.completion_tokens,t.prompt_tokens+=r.prompt_tokens,t.total_tokens+=r.total_tokens)}}catch(e){n.e(e)}finally{n.f()}return t},ke=function(e){if(null!=e.n&&e.n>1)throw new B("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},xe=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};var Le,Me,Ne,Re,Ie,Ae,Fe=["choices"],Ge=["delta","finish_reason","index","logprobs"],We=["content"],De=["content","function_call","role","tool_calls"],qe=["index","id","type","function"],Je=["id","choices","created","model","system_fingerprint"],He=["message","finish_reason","index","logprobs"],Be=["content","function_call","tool_calls"],Ue=["function","type","id"],Xe=["arguments","name"],Ye=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)},ze=function(e,t,n,r,o){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?o.call(e,n):o?o.value=n:t.set(e,n),n},Ve=function(e,t){function n(){var e;return m(this,n),e=i(this,n,arguments),Le.add(P(e)),Me.set(P(e),void 0),e}var o,a;return b(n,e),y(n,[{key:"currentChatCompletionSnapshot",get:function(){return Ye(this,Me,"f")}},{key:"_createChatCompletion",value:(a=d(l().mark((function e(t,n,o){var a,i,s,c,f,h,p,d,m,v=this;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(i=null==o?void 0:o.signal)&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",(function(){return v.controller.abort()}))),Ye(this,Le,"m",Ne).call(this),e.next=5,t.create(u(u({},n),{},{stream:!0}),u(u({},o),{},{signal:this.controller.signal}));case 5:s=e.sent,this._connected(),c=!1,f=!1,e.prev=9,p=r(s);case 11:return e.next=13,p.next();case 13:if(!(c=!(d=e.sent).done)){e.next=19;break}m=d.value,Ye(this,Le,"m",Re).call(this,m);case 16:c=!1,e.next=11;break;case 19:e.next=25;break;case 21:e.prev=21,e.t0=e.catch(9),f=!0,h=e.t0;case 25:if(e.prev=25,e.prev=26,!c||null==p.return){e.next=30;break}return e.next=30,p.return();case 30:if(e.prev=30,!f){e.next=33;break}throw h;case 33:return e.finish(30);case 34:return e.finish(25);case 35:if(null===(a=s.controller.signal)||void 0===a||!a.aborted){e.next=37;break}throw new X;case 37:return e.abrupt("return",this._addChatCompletion(Ye(this,Le,"m",Ie).call(this)));case 38:case"end":return e.stop()}}),e,this,[[9,21,25,35],[26,,30,34]])}))),function(e,t,n){return a.apply(this,arguments)})},{key:"_fromReadableStream",value:(o=d(l().mark((function e(t,n){var o,a,i,s,c,u,f,h,p,d,m=this;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:(a=null==n?void 0:n.signal)&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",(function(){return m.controller.abort()}))),Ye(this,Le,"m",Ne).call(this),this._connected(),i=I.fromReadableStream(t,this.controller),c=!1,u=!1,e.prev=7,h=r(i);case 9:return e.next=11,h.next();case 11:if(!(c=!(p=e.sent).done)){e.next=19;break}d=p.value,s&&s!==d.id&&this._addChatCompletion(Ye(this,Le,"m",Ie).call(this)),Ye(this,Le,"m",Re).call(this,d),s=d.id;case 16:c=!1,e.next=9;break;case 19:e.next=25;break;case 21:e.prev=21,e.t0=e.catch(7),u=!0,f=e.t0;case 25:if(e.prev=25,e.prev=26,!c||null==h.return){e.next=30;break}return e.next=30,h.return();case 30:if(e.prev=30,!u){e.next=33;break}throw f;case 33:return e.finish(30);case 34:return e.finish(25);case 35:if(null===(o=i.controller.signal)||void 0===o||!o.aborted){e.next=37;break}throw new X;case 37:return e.abrupt("return",this._addChatCompletion(Ye(this,Le,"m",Ie).call(this)));case 38:case"end":return e.stop()}}),e,this,[[7,21,25,35],[26,,30,34]])}))),function(e,t){return o.apply(this,arguments)})},{key:t,value:function(){var e,t,n=this,r=[],o=[],a=!1;return this.on("chunk",(function(e){var t=o.shift();t?t.resolve(e):r.push(e)})),this.on("end",(function(){a=!0;for(var e=0,t=o;e<t.length;e++){t[e].resolve(void 0)}o.length=0})),this.on("abort",(function(e){a=!0;for(var t=0,n=o;t<n.length;t++){n[t].reject(e)}o.length=0})),this.on("error",(function(e){a=!0;for(var t=0,n=o;t<n.length;t++){n[t].reject(e)}o.length=0})),{next:(t=d(l().mark((function e(){var t;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r.length){e.next=4;break}if(!a){e.next=3;break}return e.abrupt("return",{value:void 0,done:!0});case 3:return e.abrupt("return",new Promise((function(e,t){return o.push({resolve:e,reject:t})})).then((function(e){return e?{value:e,done:!1}:{value:void 0,done:!0}})));case 4:return t=r.shift(),e.abrupt("return",{value:t,done:!1});case 6:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)}),return:(e=d(l().mark((function e(){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.abort(),e.abrupt("return",{value:void 0,done:!0});case 2:case"end":return e.stop()}}),e)}))),function(){return e.apply(this,arguments)})}}},{key:"toReadableStream",value:function(){return new I(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}],[{key:"fromReadableStream",value:function(e){var t=new n;return t._run((function(){return t._fromReadableStream(e)})),t}},{key:"createChatCompletion",value:function(e,t,r){var o=new n;return o._run((function(){return o._runChatCompletion(e,u(u({},t),{},{stream:!0}),u(u({},r),{},{headers:u(u({},null==r?void 0:r.headers),{},{"X-Stainless-Helper-Method":"stream"})}))})),o}}]),n}(je,(Me=new WeakMap,Le=new WeakSet,Ne=function(){this.ended||ze(this,Me,void 0,"f")},Re=function(e){var t,n;if(!this.ended){var r=Ye(this,Le,"m",Ae).call(this,e);this._emit("chunk",e,r);var o=null===(t=e.choices[0])||void 0===t||null===(t=t.delta)||void 0===t?void 0:t.content,a=null===(n=r.choices[0])||void 0===n?void 0:n.message;null!=o&&"assistant"===(null==a?void 0:a.role)&&null!=a&&a.content&&this._emit("content",o,a.content)}},Ie=function(){if(this.ended)throw new B("stream has ended, this shouldn't happen");var e=Ye(this,Me,"f");if(!e)throw new B("request ended without sending any chunks");return ze(this,Me,void 0,"f"),function(e){var t=e.id,n=e.choices,r=e.created,o=e.model,a=e.system_fingerprint,i=_(e,Je);return u(u({},i),{},{id:t,choices:n.map((function(t){var n=t.message,r=t.finish_reason,o=t.index,a=t.logprobs,i=_(t,He);if(!r)throw new B("missing finish_reason for choice ".concat(o));var s=n.content,c=void 0===s?null:s,l=n.function_call,f=n.tool_calls,h=_(n,Be),p=n.role;if(!p)throw new B("missing role for choice ".concat(o));if(l){var d=l.arguments,m=l.name;if(null==d)throw new B("missing function_call.arguments for choice ".concat(o));if(!m)throw new B("missing function_call.name for choice ".concat(o));return u(u({},i),{},{message:{content:c,function_call:{arguments:d,name:m},role:p},finish_reason:r,index:o,logprobs:a})}return u(u({},i),{},f?{index:o,finish_reason:r,logprobs:a,message:u(u({},h),{},{role:p,content:c,tool_calls:f.map((function(t,n){var r=t.function,a=t.type,i=t.id,s=_(t,Ue),c=r||{},l=c.arguments,f=c.name,h=_(c,Xe);if(null==i)throw new B("missing choices[".concat(o,"].tool_calls[").concat(n,"].id\n").concat(Ke(e)));if(null==a)throw new B("missing choices[".concat(o,"].tool_calls[").concat(n,"].type\n").concat(Ke(e)));if(null==f)throw new B("missing choices[".concat(o,"].tool_calls[").concat(n,"].function.name\n").concat(Ke(e)));if(null==l)throw new B("missing choices[".concat(o,"].tool_calls[").concat(n,"].function.arguments\n").concat(Ke(e)));return u(u({},s),{},{id:i,type:a,function:u(u({},h),{},{name:f,arguments:l})})}))})}:{message:u(u({},h),{},{content:c,role:p}),finish_reason:r,index:o,logprobs:a})})),created:r,model:o,object:"chat.completion"},a?{system_fingerprint:a}:{})}(e)},Ae=function(e){var t,n,r,o=Ye(this,Me,"f");e.choices;var a=_(e,Fe);o?Object.assign(o,a):o=ze(this,Me,u(u({},a),{},{choices:[]}),"f");var i,s=O(e.choices);try{for(s.s();!(i=s.n()).done;){var c=i.value,l=c.delta,f=c.finish_reason,h=c.index,p=c.logprobs,d=void 0===p?null:p,m=_(c,Ge),v=o.choices[h];if(v||(v=o.choices[h]=u({finish_reason:f,index:h,message:{},logprobs:d},m)),d)if(v.logprobs){var y,g,b=d.content,w=_(d,We);if(Object.assign(v.logprobs,w),b)null!==(y=(t=v.logprobs).content)&&void 0!==y||(t.content=[]),(g=v.logprobs.content).push.apply(g,C(b))}else v.logprobs=Object.assign({},d);if(f&&(v.finish_reason=f),Object.assign(v,m),l){var k,x=l.content,P=l.function_call,S=l.role,T=l.tool_calls,E=_(l,De);if(Object.assign(v.message,E),x&&(v.message.content=(v.message.content||"")+x),S&&(v.message.role=S),P)if(v.message.function_call){if(P.name&&(v.message.function_call.name=P.name),P.arguments)null!==(k=(n=v.message.function_call).arguments)&&void 0!==k||(n.arguments=""),v.message.function_call.arguments+=P.arguments}else v.message.function_call=P;if(T){v.message.tool_calls||(v.message.tool_calls=[]);var j,L=O(T);try{for(L.s();!(j=L.n()).done;){var M,N,R=j.value,I=R.index,A=R.id,F=R.type,G=R.function,W=_(R,qe),D=null!==(M=(r=v.message.tool_calls)[I])&&void 0!==M?M:r[I]={};Object.assign(D,W),A&&(D.id=A),F&&(D.type=F),G&&(null!==(N=D.function)&&void 0!==N||(D.function={arguments:""})),null!=G&&G.name&&(D.function.name=G.name),null!=G&&G.arguments&&(D.function.arguments+=G.arguments)}}catch(e){L.e(e)}finally{L.f()}}}}}catch(e){s.e(e)}finally{s.f()}return o},Symbol.asyncIterator));function Ke(e){return JSON.stringify(e)}var $e=function(){function e(){m(this,e),this.conversation_log=[],this.final_data=[]}return y(e,[{key:"setPrompt",value:function(e){var t={role:"system",content:e,time:Math.round(performance.now())};this.final_data.push(t),this.prompt=e}},{key:"getPrompt",value:function(){var e={role:"system",content:this.prompt};return[].concat(C(this.conversation_log),[e])}},{key:"getChatLogs",value:function(){return this.final_data}},{key:"updateConversationLog",value:function(e,t,n,r){"system"===t&&console.log("WARNING: this case is not caught and is incorrectly trigerring outadated method","content:",e,"role:",t);var o=Math.round(performance.now()),a={role:t,content:e};this.conversation_log.push(a);var i=Object.assign(Object.assign({role:t,content:e,time:o},r?{message:r}:{}),n?{keyPressLog:n}:{});this.final_data.push(i)}},{key:"logMessage",value:function(e,t){var n={role:t,content:e,time:Math.round(performance.now())};this.final_data.push(n)}},{key:"cleanConversation",value:function(){return this.conversation_log.filter((function(e,t,n){return(!("role"in e)||"system"!==e.role)&&t!==n.length-1}))}},{key:"cleanSystem",value:function(e,t){var n=this.conversation_log.filter((function(e){return!("role"in e)||"system"!==e.role}));return this.conversation_log=n,this.setPrompt(e),this.getPrompt()}}]),e}(),Qe={name:"chat",parameters:{ai_prompt:{type:e.ParameterType.STRING,default:void 0},ai_model:{type:e.ParameterType.STRING,default:"gpt-4o"},chat_field_placeholder:{type:e.ParameterType.STRING,default:"Type your message here..."},continue_button:{type:e.ParameterType.COMPLEX,default:{message_trigger:0},nested:{timer_trigger:{type:e.ParameterType.INT},message_trigger:{type:e.ParameterType.INT},message:{type:e.ParameterType.STRING}}},additional_prompts:{type:e.ParameterType.COMPLEX,array:!0,default:void 0,nested:{message:{type:e.ParameterType.STRING,default:""},prompt:{type:e.ParameterType.STRING,default:null},role:{type:e.ParameterType.STRING,default:"system-prompt"},message_trigger:{type:e.ParameterType.INT,default:null},timer_trigger:{type:e.ParameterType.INT,default:null}}},prompt_chain:{type:e.ParameterType.COMPLEX,default:[],nested:{prompts:{type:e.ParameterType.STRING,array:!0,default:[]},message_trigger:{type:e.ParameterType.INT,default:1e23},timer_trigger:{type:e.ParameterType.INT,default:null}}},selection_prompt:{type:e.ParameterType.COMPLEX,default:{},nested:{prompts:{type:e.ParameterType.STRING,array:!0,default:[]},selection_prompt:{type:e.ParameterType.STRING,default:"Select one of these prompts:"},message_trigger:{type:e.ParameterType.INT,default:1e23},timer_trigger:{type:e.ParameterType.INT,default:null}}}}},Ze=function(){function e(t){m(this,e),this.jsPsych=t}return y(e,[{key:"trial",value:function(e,t){var n=this;this.initializeTrialVariables(t);var r='<div class="chat-page"><div class="chat-container">\n        <div class="chat-box" id="chat-box"></div>\n\n        <div class="chat-fields"> \n          <textarea type="text" id="user-input" placeholder="'+t.chat_field_placeholder+'"></textarea>\n          <button id="send-btn">Send</button>\n          <button id="continue-btn" style="display: none;">Continue</button>\n        </div>\n      </div>\n    </div>';e.innerHTML=r,document.body.style.backgroundColor="#9c9ad05c";var o=e.querySelector("#chat-box"),a=e.querySelector("#user-input"),i=e.querySelector("#send-btn"),s=e.querySelector("#continue-btn"),c=[],u=function(){return j(n,void 0,void 0,l().mark((function e(){var t;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=a.value.trim(),this.addMessage("user",t,o,c),c=[],a.value="",""===t||!this.selection_prompt||!this.checkCondition("selection_prompt")){e.next=9;break}return e.next=7,this.selectionPrompt(t,o);case 7:e.next=17;break;case 9:if(""===t||!this.prompt_chain||!this.checkCondition("prompt_chain")){e.next=14;break}return e.next=12,this.chainPrompts(t,o);case 12:e.next=17;break;case 14:if(""===t){e.next=17;break}return e.next=17,this.updateAndProcessGPT(o);case 17:o.scrollTop=o.scrollHeight,this.messages_sent+=1,this.checkResearcherPrompts(o,s);case 20:case"end":return e.stop()}}),e,this)})))};i.addEventListener("click",(function(e){""!=a.value.trim()&&u()})),a.addEventListener("keydown",(function(e){"Enter"===e.key&&(e.shiftKey||(e.preventDefault(),u()))})),a.addEventListener("keydown",(function(e){c.push(e.key)})),s.addEventListener("click",(function(){n.jsPsych.finishTrial({logs:n.chatLog.getChatLogs()})})),this.checkResearcherPrompts(o,s)}},{key:"initializeTrialVariables",value:function(e){this.timer_start=performance.now(),this.chatLog=new $e,this.messages_sent=0,this.ai_model=e.ai_model,this.chatLog.setPrompt(e.ai_prompt),this.researcher_prompts=e.additional_prompts?e.additional_prompts.filter((function(e){return null!==e.message_trigger||null!==e.timer_trigger||(console.error("Missing required property in researcher prompt:",e),!1)})):[];var t=e.continue_button;null===t.message_trigger&&null===t.timer_trigger?console.error("Missing required trigger property in continue prompt, will never display"):(t.role="continue",this.researcher_prompts.push(t)),e.prompt_chain&&null===e.prompt_chain.message_trigger&&null===e.prompt_chain.timer_trigger?console.error("Missing required trigger property in prompt_chain, will never trigger"):this.prompt_chain=e.prompt_chain,e.selection_prompt&&null===e.selection_prompt.message_trigger&&null===e.selection_prompt.timer_trigger?console.error("Missing required trigger property in selection_prompt, will never trigger"):this.selection_prompt=e.selection_prompt}},{key:"fetchGPT",value:function(e,t,n){return j(this,void 0,void 0,l().mark((function r(){var o,a;return l().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(r.prev=0,!window.location.href.includes("127.0.0.1")){r.next=7;break}return r.next=4,fetch("http://localhost:3000/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:e,ai_model:this.ai_model})});case 4:o=r.sent,r.next=10;break;case 7:return r.next=9,fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:e,ai_model:this.ai_model})});case 9:o=r.sent;case 10:if(o.ok){r.next=12;break}throw new Error("HTTP error! status: ".concat(o.status));case 12:return a=Ve.fromReadableStream(o.body),n&&a.on("content",(function(e,r){n.innerHTML+=e.replace(/\n/g,"<br>"),t.scrollTop=t.scrollHeight})),r.next=16,a.finalChatCompletion();case 16:return r.abrupt("return",a.messages[0].content);case 19:throw r.prev=19,r.t0=r.catch(0),console.error("Error fetching GPT data:",r.t0),r.t0;case 23:case"end":return r.stop()}}),r,this,[[0,19]])})))}},{key:"addMessage",value:function(e,t,n,r){var o=document.createElement("div");switch(e){case"chatbot":return void this.chatLog.updateConversationLog(t,"assistant");case"user":this.chatLog.updateConversationLog(t,"user",r);break;case"chatbot-message":e="chatbot",this.chatLog.logMessage(t,e);break;case"system-prompt":this.chatLog.logMessage(t,e);break;case"chatbot-prompt":e="system-prompt";break;default:return void console.error("Incorrect role")}o.className=e+"-message",o.innerHTML="",n.appendChild(o),o.innerHTML=t.replace(/\n/g,"<br>"),n.scrollTop=n.scrollHeight}},{key:"updateAndProcessGPT",value:function(e,t){return j(this,void 0,void 0,l().mark((function n(){var r,o;return l().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if((r=document.createElement("div")).className="chatbot-message",r.innerHTML="",e.appendChild(r),n.prev=4,o=void 0,!t){n.next=13;break}return n.next=9,this.fetchGPT(t,e,r);case 9:o=n.sent,console.log(t),n.next=17;break;case 13:return n.next=15,this.fetchGPT(this.chatLog.getPrompt(),e,r);case 15:o=n.sent,console.log(this.chatLog.getPrompt());case 17:return e.scrollTop=e.scrollHeight,this.addMessage("chatbot",o,e),n.abrupt("return",o);case 22:return n.prev=22,n.t0=n.catch(4),r.innerHTML="error fetching bot response",n.abrupt("return","error fetching response");case 26:case"end":return n.stop()}}),n,this,[[4,22]])})))}},{key:"checkResearcherPrompts",value:function(e,t){var n=this;this.researcher_prompts=this.researcher_prompts.filter((function(r){var o=r.message_trigger,a=r.timer_trigger,i=performance.now()-n.timer_start;if(null!==o&&n.messages_sent>=o||null!==a&&i>=a){switch(r.role){case"chatbot-message":case"system-prompt":n.addMessage(r.role,r.message,e);break;case"chatbot-prompt":var s=r.prompt,c=r.message;null!==s&&"string"==typeof s?n.chatLog.cleanSystem(s,c):console.error(r,"is missing prompt field or it isn't in the correct format"),null!==c&&"string"==typeof s&&""!==c&&n.addMessage(r.role,c,e);break;case"continue":if(!t)return console.error("No continue button to display"),!1;t.style.display="block",n.addMessage("system-prompt",r.message,e);break;default:console.error("Incorrect role for prompting")}return!1}return!0}))}},{key:"checkCondition",value:function(e){var t=performance.now()-this.timer_start,n=this[e].message_trigger,r=this[e].timer_trigger;return null!==n&&this.messages_sent>=n||null!==r&&t>=r}},{key:"chainPrompts",value:function(e,t){return j(this,void 0,void 0,l().mark((function n(){var r,o,a,i,s;return l().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=this.chatLog.cleanConversation(),o=[],a=0;case 3:if(!(a<this.prompt_chain.prompts.length)){n.next=20;break}if(i=this.prompt_chain.prompts[a],s=[].concat(C(r),[{role:"system",content:i},{role:"user",content:e}]),o.push({role:"chain-system-".concat(a),content:i},{role:"link-response-".concat(a),content:e}),a!==this.prompt_chain.prompts.length-1){n.next=14;break}return n.next=10,this.updateAndProcessGPT(t,s);case 10:e=n.sent,o.push({role:"assistant",content:e}),n.next=17;break;case 14:return n.next=16,this.fetchGPT(s,t);case 16:e=n.sent;case 17:a++,n.next=3;break;case 20:this.chatLog.logMessage(o,"chain-prompt");case 21:case"end":return n.stop()}}),n,this)})))}},{key:"selectionPrompt",value:function(e,t){return j(this,void 0,void 0,l().mark((function n(){var r,o,a,i,s,c,u,f;return l().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=this.chatLog.cleanConversation(),o="",a=0;case 3:if(!(a<this.selection_prompt.prompts.length)){n.next=14;break}return i=this.selection_prompt.prompts[a],s=[].concat(C(r),[{role:"system",content:i},{role:"user",content:e}]),console.log("individual_prompt:",s),n.next=9,this.fetchGPT(s,t);case 9:c=n.sent,o=o+"("+a+") "+c+"\n\n";case 11:a++,n.next=3;break;case 14:return u=this.selection_prompt.selection_prompt+"Task: You should select one of the three possible responses that would best achieve your goal with the intention of outputting it to the userWhat you should output: You should output the choice that you have selected, but without any indication that this was a numbered choice. Do not tell the user that you selected a certain response. The user should not know that there were choices. User message: `"+e+"`",this.chatLog.logMessage([{role:"prompt-selection",content:u},{role:"content-choices/chatbot-answers",content:o}],"selection_prompt"),f=[].concat(C(r),[{role:"system",content:u},{role:"user",content:o}]),n.next=19,this.updateAndProcessGPT(t,f);case 19:n.sent;case 20:case"end":return n.stop()}}),n,this)})))}}]),e}();return Ze.info=Qe,Ze}(jsPsychModule);
//# sourceMappingURL=index.browser.min.js.map
